<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEKAR FİLO — ONAY NO (Ortak Kullanım)</title>
  <!-- SheetJS for Excel support -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --green:#006f3c; }
    *{ box-sizing:border-box }
    body{ font-family:Arial, Helvetica, sans-serif; margin:0; background:#f4f6f5; color:#1f2937 }
    .topbar{ position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; background:var(--green); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.12) }
    .brand{ font-weight:800; letter-spacing:.3px }
    .badge{ background:rgba(255,255,255,.15); padding:4px 8px; border-radius:8px; font-weight:700 }
    .page{ margin:20px; padding:20px; background:#fff; border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,.08) }

    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:12px 0 }
    .hint{ font-size:12px; color:#475569 }

    table{ width:100%; border-collapse:collapse; margin-top:14px; font-size:14px }
    th,td{ border:1px solid #d1d5db; padding:6px; text-align:center }
    th{ background:var(--green); color:#fff }
    .red-cell{ background:#ffe2e2; color:#b91c1c; font-weight:700 }
    .green-cell{ background:#e0ffe6; color:#166534; font-weight:700 }
    .edit-btn{ background:#fb923c; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; margin:2px }
    .delete-btn{ background:#ef4444; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; margin:2px }

    /* Modal */
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ background:#fff; border-radius:12px; padding:16px; width:min(720px, 96vw); box-shadow:0 10px 30px rgba(0,0,0,.25) }
    .modal h3{ margin:0 0 10px; font-size:18px }
    .row{ display:flex; gap:10px; margin:8px 0; flex-wrap:wrap }
    .row > div{ flex:1 }
    .modal input, .modal select{ width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px }
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .btn{ padding:8px 12px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; cursor:pointer }
    .btn.primary{ background:var(--green); color:#fff; border-color:var(--green) }

    /* --- Modern form styles --- */
    .form-card{ border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:#fff }
    .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px }
    .field{ display:flex; flex-direction:column; gap:6px }
    .field label{ font-size:12px; color:#475569; font-weight:600 }
    .field input, .field select{ padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; outline:none }
    .field input:focus, .field select:focus{ border-color:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.15) }
    .actions-line{ display:flex; gap:10px; align-items:center; justify-content:flex-end }
    .primary-btn{ background:var(--green); color:#fff; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer }
    .ghost-btn{ background:#fff; border:1px solid #cbd5e1; color:#0f172a; padding:10px 14px; border-radius:12px; cursor:pointer }

    /* --- Filters & Pager --- */
    .th-filter input{ width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; font-size:12px }
    .pager{ display:flex; align-items:center; gap:8px; justify-content:flex-end; margin-top:10px }
    .pager button{ padding:6px 10px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer }
    .pager .info{ font-size:12px; color:#475569 }

    .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;z-index:60;display:none}
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <span class="brand">SEKAR FİLO</span>
      <span class="badge">ONAY NO — Ortak</span>
    </div>
    <div id="userBadge" style="background:rgba(255,255,255,.15);padding:6px 10px;border-radius:10px;display:none"></div>
  </div>

  <div id="onay" class="page">
    <div class="toolbar">
      <input type="file" id="excelInput" accept=".xlsx,.xls" />
      <button type="button" id="btnImport">Excel'den Yükle</button>
      <button type="button" id="btnTemplate">Şablonu İndir (Excel)</button>
      <button type="button" id="btnClearLocal" style="margin-left:8px">Tarayıcıdaki Kayıtları Temizle (Yerel)</button>
      <span class="hint">Başlıklar: <b>Onay No (opsiyonel)</b>, Tarih, Plaka, Firma, Km, Servis, Durum, Açıklama, Tutar, Yansıtma, Fatura No, Fatura Tutarı</span>
    </div>

    <form id="onayForm" class="form-card">
      <div class="grid">
        <div class="field" style="grid-column: span 2; min-width:140px">
          <label>Tarih</label>
          <input type="date" name="tarih" required />
        </div>
        <div class="field" style="grid-column: span 2">
          <label>Plaka</label>
          <input type="text" name="plaka" placeholder="34ABC123" required />
        </div>
        <div class="field" style="grid-column: span 3">
          <label>Firma</label>
          <input type="text" name="firma" placeholder="Şirket adı" required />
        </div>
        <div class="field" style="grid-column: span 2">
          <label>Km</label>
          <input type="number" name="km" inputmode="numeric" placeholder="0" required />
        </div>
        <div class="field" style="grid-column: span 3">
          <label>Servis</label>
          <input type="text" name="servis" placeholder="Servis adı" required />
        </div>
        <div class="field" style="grid-column: span 2">
          <label>Durum</label>
          <select name="durum" required>
            <option value="">Seçiniz</option>
            <option value="BAKIM">BAKIM</option>
            <option value="HASAR">HASAR</option>
            <option value="MEKANİK">MEKANİK</option>
            <option value="LASTİK">LASTİK</option>
            <option value="DİĞER">DİĞER</option>
          </select>
        </div>
        <div class="field" style="grid-column: span 4">
          <label>Açıklama</label>
          <input type="text" name="aciklama" placeholder="Durum açıklaması" />
        </div>
        <div class="field" style="grid-column: span 2">
          <label>Tutar</label>
          <input type="number" name="tutar" step="0.01" placeholder="0,00" required />
        </div>
        <div class="field" style="grid-column: span 2">
          <label>Yansıtma</label>
          <input type="text" name="yansitma" placeholder="VAR / YOK" />
        </div>
        <div class="actions-line" style="grid-column: 10 / span 3">
          <button type="reset" class="ghost-btn">Temizle</button>
          <button type="submit" class="primary-btn">Kaydet</button>
        </div>
      </div>
    </form>

    <table id="onayTable">
      <thead>
        <tr>
          <th>Onay No</th><th>Tarih</th><th>Plaka</th><th>Firma</th><th>Km</th><th>Servis</th>
          <th>Durum</th><th>Açıklama</th><th>Tutar</th><th>Fatura No</th><th>Fatura Tutarı</th>
          <th>Fark</th><th>Yansıtma</th><th>İşlem</th>
        </tr>
        <tr class="th-filter">
          <th><input id="f_no" placeholder="Ara" /></th>
          <th><input id="f_tarih" placeholder="gg.aa.yy" /></th>
          <th><input id="f_plaka" placeholder="Ara" /></th>
          <th><input id="f_firma" placeholder="Ara" /></th>
          <th><input id="f_km" placeholder="Ara" /></th>
          <th><input id="f_servis" placeholder="Ara" /></th>
          <th><input id="f_durum" placeholder="Ara" /></th>
          <th><input id="f_aciklama" placeholder="Ara" /></th>
          <th><input id="f_tutar" placeholder="Ara" /></th>
          <th><input id="f_faturaNo" placeholder="Ara" /></th>
          <th><input id="f_faturaTutar" placeholder="Ara" /></th>
          <th><input id="f_fark" placeholder="Ara" /></th>
          <th><input id="f_yansitma" placeholder="Ara" /></th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="pager" class="pager"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Düzenleme Modalı -->
  <div id="editWrap" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal">
      <h3 id="editTitle">Kaydı Düzenle</h3>
      <div class="row">
        <div>
          <label>Tarih</label>
          <input id="m_tarih" type="date" />
        </div>
        <div>
          <label>Plaka</label>
          <input id="m_plaka" type="text" />
        </div>
        <div>
          <label>Firma</label>
          <input id="m_firma" type="text" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Km</label>
          <input id="m_km" type="number" />
        </div>
        <div>
          <label>Servis</label>
          <input id="m_servis" type="text" />
        </div>
        <div>
          <label>Durum</label>
          <select id="m_durum">
            <option value="">Seçiniz</option>
            <option>BAKIM</option>
            <option>HASAR</option>
            <option>MEKANİK</option>
            <option>LASTİK</option>
            <option>DİĞER</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Açıklama</label>
          <input id="m_aciklama" type="text" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Tutar</label>
          <input id="m_tutar" type="number" step="0.01" />
        </div>
        <div>
          <label>Yansıtma</label>
          <input id="m_yansitma" type="text" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Fatura No</label>
          <input id="m_faturaNo" type="text" />
        </div>
        <div>
          <label>Fatura Tutarı</label>
          <input id="m_faturaTutar" type="number" step="0.01" />
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="m_cancel">Vazgeç</button>
        <button class="btn primary" id="m_save">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    // ---------- Helper UI ----------
    function toast(msg){
      var t=document.getElementById('toast'); if(!t) return;
      t.textContent=msg; t.style.display='block';
      clearTimeout(toast._h); toast._h=setTimeout(function(){t.style.display='none';}, 2000);
    }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function excelSerialToISO(n){
      var ms = Math.round((n - 25569) * 86400 * 1000);
      var dt = new Date(ms);
      return dt.getUTCFullYear()+'-'+pad2(dt.getUTCMonth()+1)+'-'+pad2(dt.getUTCDate());
    }
    function toISODate(any){
      if(any==null || any==='') return '';
      if(typeof any==='number') return excelSerialToISO(any);
      var s=String(any).trim();
      var m1=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m1) return m1[1]+'-'+m1[2]+'-'+m1[3];
      var m2=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4})$/);
      if(m2){ var d=pad2(m2[1]), mo=pad2(m2[2]); var y=m2[3]; if(y.length===2) y=((+y>50)?'19':'20')+y; return y+'-'+mo+'-'+d; }
      var dt=new Date(s); if(!isNaN(dt)) return dt.getFullYear()+'-'+pad2(dt.getMonth()+1)+'-'+pad2(dt.getDate());
      return '';
    }
    function fmtTR(anyISO){
      var s=toISODate(anyISO); if(!s) return '';
      var m = s.match(/(\\d{4})-(\\d{2})-(\\d{2})/);
      if(!m) return '';
      return m[3]+'.'+m[2]+'.'+String(m[1]).slice(2);
    }
    function toNumber(val){
      if(typeof val==='number') return val;
      var v=(val||'').toString().replace(/[\\.\\s]/g,'').replace(',','.');
      var n=Number(v); return isNaN(n)?0:n;
    }
    function isoToUTCDate(iso){
      if(!iso) return null; var m=String(iso).match(/(\\d{4})-(\\d{2})-(\\d{2})/);
      if(!m) return null; return new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
    }
    function diffDays(a,b){
      var d1=isoToUTCDate(toISODate(a)), d2=isoToUTCDate(toISODate(b));
      if(!d1||!d2) return Infinity; return Math.floor(Math.abs(d1-d2)/86400000);
    }

    // ---------- Firebase init (same project as örnek) ----------
    var firebaseConfig = {
      apiKey: "AIzaSyB-xEmeTVN8oiB4FZzV4UpJpAHkyDHYF4U",
      authDomain: "sekar-filo.firebaseapp.com",
      projectId: "sekar-filo",
      storageBucket: "sekar-filo.appspot.com",
      messagingSenderId: "61274893830",
      appId: "1:61274893830:web:c9dfdf8baf0500178f9d87"
    };
    firebase.initializeApp(firebaseConfig);
    var auth=firebase.auth();
    var db=firebase.firestore();
    var COL = db.collection('onay_kayitlari');
    var USERS = db.collection('users');
    var COUNTERS = db.collection('counters'); // doc id: year => { last: 20250000 + seq }

    // ---------- Auth overlay (@sekarfilo.com.tr) ----------
    var ov=document.createElement('div');
    ov.style.cssText="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.08);backdrop-filter:blur(2px);z-index:99999";
    ov.innerHTML = '<div style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:340px;font-family:system-ui">'+
      '<h3 style="margin:0 0 8px;font-size:18px">Giriş Yap</h3>'+
      '<input id="__m" type="email" placeholder="kisi@sekarfilo.com.tr" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
      '<input id="__p" type="password" placeholder="Şifre" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
      '<input id="__n" type="text" placeholder="Kullanıcı Adı (ilk kayıt için)" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
      '<button id="__l" style="width:100%;padding:10px;border:0;border-radius:8px;background:#0ea675;color:#fff">Giriş</button>'+
      '<button id="__s" style="width:100%;padding:10px;border:0;border-radius:8px;background:#334155;color:#fff;margin-top:6px">Hesap Oluştur</button>'+
      '<div id="__e" style="color:#d92d20;font-size:12px;min-height:16px;margin-top:6px"></div>'+
      '<div style="font-size:12px;color:#64748b;margin-top:4px">* Sadece @sekarfilo.com.tr kabul edilir.</div>'+
    '</div>';
    document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(ov); });
    function showLogin(v){ ov.style.display = v ? 'flex' : 'none'; }
    function err(t){ var el=document.getElementById('__e'); if(el) el.textContent=t||''; }

    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='__l'){
        var m=document.getElementById('__m').value.trim();
        var p=document.getElementById('__p').value;
        if(!/@sekarfilo\\.com\\.tr$/i.test(m)) return err("Sadece @sekarfilo.com.tr");
        auth.signInWithEmailAndPassword(m,p).catch(function(x){err(x.message||String(x));});
      }
      if(e.target && e.target.id==='__s'){
        var m=document.getElementById('__m').value.trim();
        var p=document.getElementById('__p').value;
        var n=document.getElementById('__n').value.trim();
        if(!/@sekarfilo\\.com\\.tr$/i.test(m)) return err("Sadece @sekarfilo.com.tr");
        if(!n) return err("Lütfen kullanıcı adı girin");
        auth.createUserWithEmailAndPassword(m,p).then(function(cred){
          var user=cred.user;
          return user.updateProfile({ displayName: n }).then(function(){
            return USERS.doc(user.uid).set({ uid:user.uid, email:user.email, displayName:n, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          });
        }).catch(function(x){err(x.message||String(x));});
      }
    }, true);

    // ---------- Yearly counter via transaction ----------
    function yearFromISO(iso){
      var s=toISODate(iso); if(!s) return (new Date()).getFullYear();
      var m=s.match(/^(\\d{4})-/); return m ? +m[1] : (new Date()).getFullYear();
    }
    function baseForYear(y){ return (y*10000); }
    function nextOnayNoTx(isoDate){
      var y = yearFromISO(isoDate);
      var ref = COUNTERS.doc(String(y));
      return db.runTransaction(function(tx){
        return tx.get(ref).then(function(doc){
          var base = baseForYear(y);
          var last = doc.exists && typeof doc.data().last==='number' ? doc.data().last : base;
          var next = (last >= base ? last+1 : base+1);
          tx.set(ref, { last: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          return next;
        });
      });
    }

    // ---------- Local state + filters/pager ----------
    var PAGE_SIZE=50;
    var page=1;
    var records=[]; // {no,tarih,plaka,firma,km,servis,durum,aciklama,tutar,faturaNo,faturaTutar,yansitma,createdBy,createdAt}
    var filters = { no:'', tarih:'', plaka:'', firma:'', km:'', servis:'', durum:'', aciklama:'', tutar:'', faturaNo:'', faturaTutar:'', fark:'', yansitma:'' };
    function applyFilters(list){
      function norm(s){ return (s==null?'':String(s)).toUpperCase(); }
      return list.filter(function(r){
        var fark=(r.faturaTutar||0)-(r.tutar||0);
        return (!filters.no || String(r.no).includes(filters.no))
          && (!filters.tarih || fmtTR(r.tarih).includes(filters.tarih))
          && (!filters.plaka || norm(r.plaka).includes(norm(filters.plaka)))
          && (!filters.firma || norm(r.firma).includes(norm(filters.firma)))
          && (!filters.km || String(r.km).includes(filters.km))
          && (!filters.servis || norm(r.servis).includes(norm(filters.servis)))
          && (!filters.durum || norm(r.durum).includes(norm(filters.durum)))
          && (!filters.aciklama || norm(r.aciklama).includes(norm(filters.aciklama)))
          && (!filters.tutar || String(r.tutar).includes(filters.tutar))
          && (!filters.faturaNo || norm(r.faturaNo).includes(norm(filters.faturaNo)))
          && (!filters.faturaTutar || String(r.faturaTutar).includes(filters.faturaTutar))
          && (!filters.fark || String(fark).includes(filters.fark))
          && (!filters.yansitma || norm(r.yansitma).includes(norm(filters.yansitma)));
      });
    }
    function renderPager(total, totalPages){
      var el=document.getElementById('pager'); if(!el) return; el.innerHTML='';
      var info=document.createElement('span'); info.className='info';
      var start=(page-1)*PAGE_SIZE+1, end=Math.min(page*PAGE_SIZE,total);
      info.textContent=start+'-'+end+'/'+total;
      function mk(t,cb,dis){ var b=document.createElement('button'); b.textContent=t; b.disabled=!!dis; b.onclick=cb; return b; }
      el.appendChild(mk('⏮', function(){page=1; render();}, page===1));
      el.appendChild(mk('◀', function(){page=Math.max(1,page-1); render();}, page===1));
      el.appendChild(info);
      el.appendChild(mk('▶', function(){page=Math.min(totalPages,page+1); render();}, page===totalPages));
      el.appendChild(mk('⏭', function(){page=totalPages; render();}, page===totalPages));
    }
    function render(){
      var tb=document.querySelector('#onayTable tbody'); if(!tb) return; tb.innerHTML='';
      var sorted=[].concat(records).sort(function(a,b){ return b.no - a.no; });
      var filtered=applyFilters(sorted);
      var total=filtered.length; var totalPages=Math.max(1, Math.ceil(total/PAGE_SIZE)); if(page>totalPages) page=totalPages;
      var slice=filtered.slice((page-1)*PAGE_SIZE, page*PAGE_SIZE);
      slice.forEach(function(r){
        var idx = records.findIndex(function(x){ return x.no===r.no; });
        var fark=(r.faturaTutar||0)-(r.tutar||0);
        var farkClass = fark>50 ? 'red-cell' : (fark>0 ? 'green-cell' : '');
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+r.no+'</td><td>'+fmtTR(r.tarih)+'</td><td>'+r.plaka+'</td><td>'+r.firma+'</td>'+
                       '<td>'+r.km+'</td><td>'+r.servis+'</td><td>'+r.durum+'</td><td>'+(r.aciklama||'')+'</td>'+
                       '<td>'+ (r.tutar? new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(r.tutar):"") +'</td>'+
                       '<td>'+(r.faturaNo||"")+'</td>'+
                       '<td>'+ (r.faturaTutar? new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(r.faturaTutar):"") +'</td>'+
                       '<td class="'+farkClass+'">'+(fark? new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(fark):"")+'</td>'+
                       '<td>'+(r.yansitma||"")+'</td>'+
                       '<td><button class="edit-btn" data-act="edit" data-id="'+r.no+'">Düzenle</button>'+
                       '<button class="delete-btn" data-act="del" data-id="'+r.no+'">Sil</button></td>';
        tb.appendChild(tr);
      });
      renderPager(total, totalPages);
    }

    // ---------- CRUD (Firestore) ----------
    function recordFromForm(fd){
      return {
        tarih: toISODate(fd.get('tarih')),
        plaka: String(fd.get('plaka')||'').toUpperCase(),
        firma: String(fd.get('firma')||'').toUpperCase(),
        km: toNumber(fd.get('km')),
        servis: String(fd.get('servis')||'').toUpperCase(),
        durum: String(fd.get('durum')||''),
        aciklama: String(fd.get('aciklama')||''),
        tutar: toNumber(fd.get('tutar')),
        yansitma: String(fd.get('yansitma')||''),
        faturaNo: '',
        faturaTutar: 0
      };
    }
    function createWithCounter(base){
      // base: fields without no; need to get next no by year of base.tarih
      return nextOnayNoTx(base.tarih||new Date()).then(function(no){
        var user=auth.currentUser || {};
        var rec = Object.assign({}, base, {
          no: no,
          createdBy: user.email || '',
          createdByUid: user.uid || '',
          createdByName: (user.displayName || (user.email?user.email.split('@')[0]:'')),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return COL.doc(String(no)).set(rec).then(function(){ return no; });
      });
    }
    function upsertProvidedNo(rec){
      // when importing with provided 'no'
      var y = yearFromISO(rec.tarih);
      var refC = COUNTERS.doc(String(y));
      return db.runTransaction(function(tx){
        return tx.get(refC).then(function(doc){
          var base=baseForYear(y);
          var last = doc.exists && typeof doc.data().last==='number' ? doc.data().last : base;
          if(rec.no > last){
            tx.set(refC, { last: rec.no, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          }
        });
      }).then(function(){
        return COL.doc(String(rec.no)).set(rec, { merge:true });
      });
    }
    function updateByNo(no, patch){
      patch = Object.assign({}, patch, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      return COL.doc(String(no)).set(patch, { merge:true });
    }
    function deleteByNo(no){ return COL.doc(String(no)).delete(); }

    // ---------- Real-time subscription ----------
    var unsub=null;
    function subscribe(){
      if(unsub) unsub();
      unsub = COL.orderBy('createdAt','desc').onSnapshot(function(snap){
        var arr = snap.docs.map(function(d){ return d.data(); });
        // Keep a local cache (for faster filters; not a source of truth)
        try{ localStorage.setItem('onayRecords', JSON.stringify(arr)); }catch(e){}
        records = arr;
        render();
      }, function(e){
        console.warn('subscribe error', e);
      });
    }

    // ---------- Events ----------
    document.addEventListener('DOMContentLoaded', function(){
      // filters
      var fmap={ no:'f_no', tarih:'f_tarih', plaka:'f_plaka', firma:'f_firma', km:'f_km', servis:'f_servis', durum:'f_durum', aciklama:'f_aciklama', tutar:'f_tutar', faturaNo:'f_faturaNo', faturaTutar:'f_faturaTutar', fark:'f_fark', yansitma:'f_yansitma' };
      Object.keys(fmap).forEach(function(k){
        var el=document.getElementById(fmap[k]); if(!el) return;
        el.addEventListener('input', function(){ filters[k]=el.value; page=1; render(); });
      });

      // table actions (edit/delete)
      document.querySelector('#onayTable').addEventListener('click', function(e){
        var btn=e.target.closest('button'); if(!btn) return;
        var act=btn.getAttribute('data-act'); var id=btn.getAttribute('data-id');
        if(act==='edit'){
          var r=records.find(function(x){ return String(x.no)===String(id); });
          if(!r) return;
          document.getElementById('m_tarih').value = toISODate(r.tarih)||'';
          document.getElementById('m_plaka').value = r.plaka||'';
          document.getElementById('m_firma').value = r.firma||'';
          document.getElementById('m_km').value = r.km||'';
          document.getElementById('m_servis').value = r.servis||'';
          document.getElementById('m_durum').value = r.durum||'';
          document.getElementById('m_aciklama').value = r.aciklama||'';
          document.getElementById('m_tutar').value = r.tutar||'';
          document.getElementById('m_yansitma').value = r.yansitma||'';
          document.getElementById('m_faturaNo').value = r.faturaNo||'';
          document.getElementById('m_faturaTutar').value = r.faturaTutar||'';
          document.getElementById('editWrap').style.display='flex';
          document.getElementById('m_save').onclick=function(){
            var patch={
              tarih: toISODate(document.getElementById('m_tarih').value),
              plaka: String(document.getElementById('m_plaka').value||'').toUpperCase(),
              firma: String(document.getElementById('m_firma').value||'').toUpperCase(),
              km: toNumber(document.getElementById('m_km').value),
              servis: String(document.getElementById('m_servis').value||'').toUpperCase(),
              durum: String(document.getElementById('m_durum').value||''),
              aciklama: String(document.getElementById('m_aciklama').value||''),
              tutar: toNumber(document.getElementById('m_tutar').value),
              yansitma: String(document.getElementById('m_yansitma').value||''),
              faturaNo: String(document.getElementById('m_faturaNo').value||''),
              faturaTutar: toNumber(document.getElementById('m_faturaTutar').value)
            };
            updateByNo(id, patch).then(function(){
              document.getElementById('editWrap').style.display='none';
              toast('Kayıt güncellendi');
            }).catch(function(err){ alert('Güncellenemedi: ' + (err.message||err)); });
          };
          document.getElementById('m_cancel').onclick=function(){
            document.getElementById('editWrap').style.display='none';
          };
        } else if(act==='del'){
          if(!confirm('Kaydı silmek istiyor musunuz?')) return;
          deleteByNo(id).then(function(){ toast('Kayıt silindi'); }).catch(function(err){ alert('Silinemedi: ' + (err.message||err)); });
        }
      });

      // form submit -> transaction counter + create
      document.getElementById('onayForm').addEventListener('submit', function(e){
        e.preventDefault();
        var f=new FormData(e.target);
        var base=recordFromForm(f);
        // 0–7 gün uyarısı (aynı plakaya)
        var hasRecent = records.some(function(r){ return r && r.plaka && r.tarih && r.plaka===base.plaka && (diffDays(base.tarih, r.tarih) >= 0 && diffDays(base.tarih, r.tarih) <= 7); });
        if(hasRecent && !confirm('Bu plakaya ait son 0–7 gün içinde başka bir kayıt var. Devam edilsin mi?')) return;
        createWithCounter(base).then(function(){
          e.target.reset(); toast('Kayıt eklendi');
        }).catch(function(err){ alert('Kaydedilemedi: ' + (err.message||err)); });
      });

      // Excel template
      document.getElementById('btnTemplate').addEventListener('click', function(){
        var wb = XLSX.utils.book_new();
        var headers = ["Onay No","Tarih","Plaka","Firma","Km","Servis","Durum","Açıklama","Tutar","Yansıtma","Fatura No","Fatura Tutarı"];
        var ws = XLSX.utils.aoa_to_sheet([headers]);
        XLSX.utils.book_append_sheet(wb, ws, 'OnayNo');
        XLSX.writeFile(wb, "onayno_sablon.xlsx");
      });

      // Excel import -> Firestore
      document.getElementById('btnImport').addEventListener('click', function(){
        var inp=document.getElementById('excelInput'); if(!inp.files||!inp.files[0]){ toast('Lütfen bir Excel dosyası seçin.'); return; }
        var file=inp.files[0], fr=new FileReader();
        fr.onload=function(ev){
          var data=new Uint8Array(ev.target.result); var rows=[];
          try{ var wb=XLSX.read(data,{type:'array'}); var ws=wb.Sheets[wb.SheetNames[0]]; rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:""}); }
          catch(err){ var txt=new TextDecoder('utf-8').decode(data); rows=txt.split(/\\r?\\n/).map(function(r){ return r.split(','); }); }
          if(!rows.length){ toast('Dosya boş görünüyor.'); return; }
          var header=rows[0].map(function(h){ return String(h).trim(); });
          function idx(n){ return header.indexOf(n); }
          var hasOnayNo = header.includes('Onay No');
          var map = {
            OnayNo: hasOnayNo ? idx('Onay No') : -1,
            Tarih: idx('Tarih'), Plaka: idx('Plaka'), Firma: idx('Firma'), Km: idx('Km'), Servis: idx('Servis'),
            Durum: idx('Durum'), Açıklama: idx('Açıklama'), Tutar: idx('Tutar'), Yansıtma: idx('Yansıtma'),
            FaturaNo: idx('Fatura No'), FaturaTutar: idx('Fatura Tutarı')
          };
          var ok=0, skipped=0;
          (function next(i){
            if(i>=rows.length){ toast(ok+' kayıt yüklendi'+(skipped?(' ('+skipped+' atlandı)'):"")); return; }
            var r=rows[i]; if(!r || r.every(function(c){return String(c).trim()==='';})) { next(i+1); return; }
            var base = {
              tarih: toISODate(r[map.Tarih]),
              plaka: String(r[map.Plaka]||'').toUpperCase(),
              firma: String(r[map.Firma]||'').toUpperCase(),
              km: toNumber(r[map.Km]),
              servis: String(r[map.Servis]||'').toUpperCase(),
              durum: String(r[map.Durum]||''),
              aciklama: String(r[map['Açıklama']]||''),
              tutar: toNumber(r[map.Tutar]),
              yansitma: String(r[map.Yansıtma]||''),
              faturaNo: String(r[map.FaturaNo]||''),
              faturaTutar: toNumber(r[map.FaturaTutar]||0)
            };
            var provided = hasOnayNo ? String(r[map.OnayNo]||'').trim() : '';
            if(provided){
              var pn = parseInt(provided.replace(/\\D/g,''),10);
              if(!isFinite(pn)){ skipped++; next(i+1); return; }
              // skip if exists
              COL.doc(String(pn)).get().then(function(snap){
                if(snap.exists){ skipped++; next(i+1); return; }
                var user=auth.currentUser || {};
                var rec = Object.assign({ no: pn }, base, {
                  createdBy: user.email||'', createdByUid: user.uid||'', createdByName: (user.displayName || (user.email?user.email.split('@')[0]:'')),
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return upsertProvidedNo(rec).then(function(){ ok++; next(i+1); });
              }).catch(function(){ skipped++; next(i+1); });
            }else{
              createWithCounter(base).then(function(){ ok++; next(i+1); }).catch(function(){ skipped++; next(i+1); });
            }
          })(1);
        };
        fr.readAsArrayBuffer(file);
      });

      // local clear (does not touch Firestore)
      document.getElementById('btnClearLocal').addEventListener('click', function(){
        if(!confirm('Tarayıcıdaki yerel önbellek temizlensin mi? (Ortak veriler etkilenmez)')) return;
        try{ localStorage.removeItem('onayRecords'); }catch(e){}
        toast('Yerel önbellek temizlendi');
      });
    });

    // ---------- Auth state -> subscribe ----------
    auth.onAuthStateChanged(function(user){
      var badge=document.getElementById('userBadge');
      if(user && /@sekarfilo\\.com\\.tr$/i.test(user.email||'')){
        if(badge){ badge.style.display='block'; badge.textContent = user.displayName || user.email; }
        showLogin(false);
        USERS.doc(user.uid).set({ email:user.email, displayName:user.displayName || (user.email?user.email.split('@')[0]:''), lastLogin: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }).catch(function(){});
        subscribe();
      }else{
        if(badge){ badge.style.display='none'; }
        showLogin(true);
      }
    });
  })();
  </script>
</body>
</html>
